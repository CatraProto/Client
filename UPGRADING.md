# How to upgrade to a newer layer
### Context
CatraProto provides a simplified API for some Telegram features. This simplified API (eg. File Handling) needs to be maintained and to be update when necessary to keep everything working correctly.
The CatraProto.TL.Generator (which requires some refactoring, so PRs are welcome) provides some tools to easily track changes across the entire schema and help make the right adjustments:

- _schema.tl_ is where all TL schemas are defined, including the ones internally used by CatraProto.
- _knownContexts.json_ is a JSON-encoded list of all constructors (together with their IDs, to easily check if the constructor changed) that contain either a Document, a Photo object or another TL-Object which eventually links to one of the first two.
- _watchFor.catraWatch_ is a hand-written file used to manually get notified if one or more of the constructors specified have changed.

All of these checks run automatically when generating TL related code.

## What to do when changes are detected in _knownContexts.json_
When a new constructor bringing to a Photo or Document object (_file object_, from now on) it's of vital importance to update the [code](https://github.com/CatraProto/Client/blob/master/src/CatraProto.Client/ApiManagers/Files/FileLocation.cs) that handles contexts.
When adding a new context it is not necessary to update the _FileIdVersion_, older versions of CatraProto are supposed to return an error if they don't recognize a context. Instead, the version is supposed to be incremented when a breaking change to the serialization is scheme is made.

The current **FileId** scheme looks like this:
```
| version (u16) | type (u16) | id (i64) | access_hash (i64) | dc_id (i32) | size (i64) | static_sizes (i32 + PhotoSize objects) | video_sizes (i32 + VideoSize objects) | file_reference (bytes) | context (Context object) |
```

The current **UniqueId** scheme looks like this:
```
| version (u16) | type (u16) | id (i64) | dc_id (i32) |
```

When new or different contexts are detected a new context object in _schema.tl_ **must** be created. If a context object must be changed a new one has to be created with the same name as the old one but with a version number at the end.
It is also useful (but not mandatory, unless it's not clear what has changed) to add a comment describing the difference from the previous version.

**Old Context:**

```
contextFromMessage#e11a9fd9 peer:long msg_id:int = Context;
```

**New Context:**
```
// This context is different from contextFromMessage previous for the following reasons:
// - A new pikachu parameter was added by Telegram to each message, and it is required to use getMessages.
// - The peer parameter now only accepts values divisible by 2
contextFromMessageV2#e11a9fd9 peer:long msg_id:int pikachu:int = Context;
```
Just like the TL schema provided by Telegram, the constructor ID must be generated by computing the CRC32 value of the objects except the semicolon and the ID.
```
// used to generate ID
contextFromMessageV2 peer:long msg_id:int pikachu:int = Context

// written in schema.tl
contextFromMessageV2#e11a9fd9 peer:long msg_id:int pikachu:int = Context;
```

The old context **must not** be removed from the __schema.tl__ file. Obviously, the code in _FileLocation.cs_ must also be changed in order to accomodate these changes.

## What to do when changes are detected in _watchFor.catrawatch_
### - photoSize and/or videoSize have changed:
In this case, it is important to create new objects in order not to lose backwards compatibility. The object must meet the following requirements:
- It **must** have the same name as the previous object, except it must end with "OldX" where X is an increasing number starting from 1.
- It **must** be locate under the _CatraProto.Client.TL.Schemas.Sizes_ in the _schema.tl_ file.
- The constructor ID **must** be the same as the old object. If the new Id is _1234_, and the old one is _3212_, this object we're creating must have Id _3212_.

Obviously, the code must be updated to convert (while deserializing) the old object to the newest one.

### - inputMediaUploadedDocument and/or inputMediaUploadedPhoto have changed:
// TODO: Write documentation when alternatives to these two methods are created

## Move the new objects to the right directories
To bring to life the changes we've written in __schema.tl__ you must follow these steps:
- Navigate to _src/CatraProto.Client/TL/Requests_
- Delete everything **except** the _Overrides_ folder
- Navigate to _src/CatraProto.Client/TL/Schemas_
- Delete everything **except** the _Overrides_ folder and _MergedProvider.cs_
- Delete _src/CatraProto.Client/Updates/UpdateTools.cs_
- Navigate to __src/CatraProto.TL.Generator/bin/Build_Config_/dotnet_version/_
- Delete the _CatraProto_ folder
- Run the code generator
- Copy the contents of _CatraProto/Client\TL_ to _src/CatraProto.Client/TL/_
- Copy _CatraProto/Client/Updates/UpdateTools.Autogen.cs_ to _src/CatraProto.Client/Updates/_

## Final remarks
It's also important to update this document when necessary. PRs are welcome but they must meet all requirements.
